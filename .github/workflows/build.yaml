name: "Test"

on:
    pull_request:

jobs:
    # ubuntu_22_04:
    #   runs-on: ubuntu-latest
    #   name: Ubuntu 22.04
    #   steps: 
    #     - name: Clone wake
    #       uses: actions/checkout@v2
    #       with:
    #         fetch-depth: 0
    #     - name: Build
    #       uses: ./.github/actions/ubuntu_22_04/
    #       id: ubuntu_22_04
    #
    # hello: 
    #   runs-on: ubuntu-latest
    #   name: Hello Test
    #   steps:
    #     - name: "Clone wake"
    #       uses: actions/checkout@v2
    #       with:
    #         fetch-depth: 0
    #
    #     - name: Hello world
    #       uses: ./.github/actions/hello/
    #       id: hello
    #       with: 
    #         who-to-greet: 'Hello custom action'
    #         
    #     - name: Get the time
    #       run: echo "The time was ${{ steps.hello.outputs.time }}"
  #
    tarball:
      runs-on: ubuntu-latest
      name: Tarball
      steps: 
        - name: Clone wake
          uses: actions/checkout@v3
          with:
            fetch-depth: 0

        - name: Install Deps
          run: sudo apt-get update && sudo apt-get install -y build-essential fuse libfuse-dev libsqlite3-dev libgmp-dev libncurses5-dev pkg-config git g++ gcc libre2-dev python3-sphinx clang-format-12

        - name: Check Formatting
          run: clang-format-12 --style=file --Werror -n $(./scripts/which_clang_files all)

        - name: Build Tarball
          run: make tarball

        - name: Run Tests
          run: make test && make unittest

        - name: Generate Docs
          run: mkdir www && ./bin/wake --no-workspace --html > www/index.html

        - name: wake to rst
          run: PATH=$(pwd)/bin:$PATH PYTHONPATH=$(pwd)/scripts python3 scripts/wake2rst.py

        - name: Upload build artifacts
          uses: actions/upload-artifact@v3
          with:
            name: tarball
            path: wake_*.tar.xz

        - name: Upload build artifacts
          uses: actions/upload-artifact@v3
          with:
            name: Dockerfile 
            path: .circleci/dockerfiles/wasm 


      # - persist_to_workspace:
      #     root: .
      #     paths:
      #       - .circleci/dockerfiles
      #       - wake_*.tar.xz
      #       - debian
      #       - www
      #       - tests
      #       - scripts/sphinx/build/html



    vscode_stable:
      runs-on: ubuntu-latest
      needs: tarball
      name: VSCode Extension (stable)
      steps: 
        - name: Download Tarball
          uses: actions/download-artifact@v3
          with:
            name: tarball

        - name: Download Dockerfile
          uses: actions/download-artifact@v3
          with:
            name: Dockerfile

        - name: Build docker image
          run: docker build -f wasm -t wake-wasm .

        - name: Create docker shared build directory
          run: mkdir build && chmod ugo+rwx build

        - name: Copy wake resources to build directory
          run: cp wake_*.tar.xz build

        - name: Build Wake
          run: docker run -u build --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-wasm /bin/sh -c 'tar xvJf wake_*.tar.xz && make -C wake-* vscode'

        - name: Install vsix
          run: install -D -t release/vscode build/wake-*/extensions/vscode/wake-*.vsix

        - name: Test ls 
          run: ls release/vscode 

        - name: Upload build artifacts
          uses: actions/upload-artifact@v3
          with:
            name: vscode-extension-stable 
            path: release/vscode/*.vsix

    
    
    build:
        name: "MacOS build"
        runs-on: macos-10.15

        steps:
            - name: "Clone wake"
              uses: actions/checkout@v2
              with:
                fetch-depth: 0
          
            - name: "Install deps"
              run: |
                brew install --cask osxfuse
                brew install re2 || brew install re2 --head

            - name: "Build wake"
              run: make all -j3

            - name: "Test wake"
              run: make test
