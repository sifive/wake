name: "Test"

on:
    pull_request:

jobs:
    # ubuntu_22_04:
    #   runs-on: ubuntu-latest
    #   name: Ubuntu 22.04
    #   steps: 
    #     - name: Clone wake
    #       uses: actions/checkout@v2
    #       with:
    #         fetch-depth: 0
    #     - name: Build
    #       uses: ./.github/actions/ubuntu_22_04/
    #       id: ubuntu_22_04
    #
    # hello: 
    #   runs-on: ubuntu-latest
    #   name: Hello Test
    #   steps:
    #     - name: "Clone wake"
    #       uses: actions/checkout@v2
    #       with:
    #         fetch-depth: 0
    #
    #     - name: Hello world
    #       uses: ./.github/actions/hello/
    #       id: hello
    #       with: 
    #         who-to-greet: 'Hello custom action'
    #         
    #     - name: Get the time
    #       run: echo "The time was ${{ steps.hello.outputs.time }}"
    
    ubuntu_22_04:
      runs-on: ubuntu-latest
      name: Ubuntu 22.04
      steps: 
        - name: Clone wake
          uses: actions/checkout@v2
          with:
            fetch-depth: 0

        - name: Build docker image
          run: docker build -f ./.circleci/dockerfiles/ubuntu-22.04 -t wake-ubuntu-22.04 .

        - name: Create docker shared build directory
          run: mkdir build && chmod ugo+rwx build

        - name: Copy wake resources to build directory
          run: cp -R wake build

        - name: Build Wake
          run: docker run -u build --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-ubuntu-22.04 /bin/sh -c 'cd wake && make -C tarball'
    
    
    build:
        name: "MacOS build"
        runs-on: macos-10.15

        steps:
            - name: "Clone wake"
              uses: actions/checkout@v2
              with:
                fetch-depth: 0
          
            - name: "Install deps"
              run: |
                brew install --cask osxfuse
                brew install re2 || brew install re2 --head

            - name: "Build wake"
              run: make all -j3

            - name: "Test wake"
              run: make test
