name: "Test"

on:
    pull_request:

jobs:
    tarball:
      runs-on: ubuntu-latest
      name: Tarball
      steps: 
        - name: Clone wake
          uses: actions/checkout@v3
          with:
            fetch-depth: 0

        - name: Install Deps
          run: sudo apt-get update && sudo apt-get install -y build-essential fuse libfuse-dev libsqlite3-dev libgmp-dev libncurses5-dev pkg-config git g++ gcc libre2-dev python3-sphinx clang-format-12

        - name: Check Formatting
          run: clang-format-12 --style=file --Werror -n $(./scripts/which_clang_files all)

        - name: Build Tarball
          run: make tarball

        - name: Run Tests
          run: make test && make unittest

        - name: Generate Docs
          run: mkdir www && ./bin/wake --no-workspace --html > www/index.html

        - name: wake to rst
          run: PATH=$(pwd)/bin:$PATH PYTHONPATH=$(pwd)/scripts python3 scripts/wake2rst.py

        - name: Upload tarball 
          uses: actions/upload-artifact@v3
          with:
            name: tarball
            path: wake_*.tar.xz

        - name: Upload Dockerfiles 
          uses: actions/upload-artifact@v3
          with:
            name: dockerfiles
            path: .circleci/dockerfiles/

        - name: Upload debian files
          uses: actions/upload-artifact@v3
          with:
            name: debian
            path: debian 

        - name: Upload www files
          uses: actions/upload-artifact@v3
          with:
            name: www
            path: www 

        - name: Upload test artifacts 
          uses: actions/upload-artifact@v3
          with:
            name: tests
            path: tests

        - name: Upload html 
          uses: actions/upload-artifact@v3
          with:
            name: html
            path: scripts/sphinx/build/html

    vscode_latest:
      runs-on: ubuntu-latest
      needs: tarball
      name: VSCode Extension (latest)
      steps: 
        - name: Create target directories
          run: mkdir dockerfiles && mkdir build && chmod ugo+rwx build

        - name: Download Tarball
          uses: actions/download-artifact@v3
          with:
            name: tarball
            path: build

        - name: Download Dockerfiles
          uses: actions/download-artifact@v3
          with:
            name: dockerfiles
            path: dockerfiles

        - name: Uncompress tarball
          run: tar xvJf build/wake_*.tar.xz -C build

        - name: Build docker image
          run: docker build -f dockerfiles/wasm --build-arg EMSDK_VERISON=latest -t wake-wasm .

        - name: Build vsix
          run: docker run -u build --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-wasm /bin/sh -c 'make -C wake-* vscode'


    vscode_stable:
      runs-on: ubuntu-latest
      needs: tarball
      name: VSCode Extension (stable)
      steps: 
        - name: Create target directories
          run: mkdir dockerfiles && mkdir build && chmod ugo+rwx build

        - name: Download Tarball
          uses: actions/download-artifact@v3
          with:
            name: tarball
            path: build

        - name: Download Dockerfiles
          uses: actions/download-artifact@v3
          with:
            name: dockerfiles
            path: dockerfiles

        - name: Uncompress tarball
          run: tar xvJf build/wake_*.tar.xz -C build

        - name: Build docker image
          run: docker build -f dockerfiles/wasm -t wake-wasm .

        - name: Build vsix
          run: docker run -u build --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-wasm /bin/sh -c 'make -C wake-* vscode'

        - name: Install vsix
          run: install -D -t release/vscode build/wake-*/extensions/vscode/wake-*.vsix

        - name: Upload vsix 
          uses: actions/upload-artifact@v3
          with:
            name: vscode-stable 
            path: release/vscode

    wasm:
      runs-on: ubuntu-latest
      needs: tarball
      name: WASM Build
      steps:
        - name: Create target directories
          run: mkdir dockerfiles && mkdir build && chmod ugo+rwx build

        - name: Download Tarball
          uses: actions/download-artifact@v3
          with:
            name: tarball
            path: build

        - name: Download Dockerfiles
          uses: actions/download-artifact@v3
          with:
            name: dockerfiles
            path: dockerfiles

        - name: Uncompress tarball
          run: tar xvJf build/wake_*.tar.xz -C build

        - name: Build docker image
          run: docker build -f dockerfiles/wasm -t wake-wasm .

        - name: Build wasm target
          run: docker run -u build --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-wasm /bin/sh -c 'make -C wake-* wasm'

    alpine:
      runs-on: ubuntu-latest
      needs: tarball
      name: Alpine Build
      steps:
      steps:
        - name: Create target directories
          run: mkdir dockerfiles && mkdir -p build/tests && chmod ugo+rwx build

        - name: Download Tarball
          uses: actions/download-artifact@v3
          with:
            name: tarball
            path: build

        - name: Download Test Artifacts
          uses: actions/download-artifact@v3
          with:
            name: tests
            path: build/tests

        - name: Download Dockerfiles
          uses: actions/download-artifact@v3
          with:
            name: dockerfiles
            path: dockerfiles

        - name: Uncompress tarball
          run: tar xvJf build/wake_*.tar.xz -C build

        - name: Build docker image
          run: docker build -f dockerfiles/alpine -t wake-alpine .

        - name: Build alpine target
          run: docker run --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-alpine /bin/sh -c 'make -C wake-* static' 

        - name: Run alpine tests
          run: docker run --rm --mount type=bind,source=$PWD/build,target=/build --device /dev/fuse --cap-add SYS_ADMIN --security-opt apparmor:unconfined wake-alpine /bin/sh -c "tar xvJf wake-*/wake-static_* && cd tests && ../wake-*/bin/wake runTests

        - name: Install alpine
          run: install -D -t release/alpine wake-*/wake-static_*

        - name: Upload alpine
          uses: actions/upload-artifact@v3
          with:
            name: alpine 
            path: release/alpine


    
    macos_10_15:
        name: MacOS Build
        runs-on: macos-10.15

        steps:
            - name: Clone wake
              uses: actions/checkout@v2
              with:
                fetch-depth: 0
          
            - name: Install deps
              run: |
                brew install --cask osxfuse
                brew install re2 || brew install re2 --head

            - name: Build wake
              run: make all -j3

            - name: Test wake
              run: make test

